<!--pages/quiz/quiz.wxml-->
<view class="container" wx:if="{{questions.length > 0}}">
  <view class="current-filter-display" wx:if="{{currentFilterDisplay}}">
    <text>当前范围: {{currentFilterDisplay}}</text>
  </view>
  <view class="quiz-info">
    <text class="score-display">得分: {{score}}</text>
    <text class="timer-display">用时: {{timeFormatter.formatTime(timeSpent)}}</text>
    <text class="progress-display">进度: {{currentQuestionIndex + 1}} / {{totalQuestions}}</text>
  </view>

  <block wx:if="{{questions[currentQuestionIndex]}}">
    <view class="question-card">
      <!-- 问题区域 -->
      <view class="question-header">
        <view class="question-stem-container">
          <text class="question-word">{{questions[currentQuestionIndex].wordToDisplay}}</text>
          <view class="part-of-speech-tag {{questions[currentQuestionIndex].partOfSpeech}}">
            {{questions[currentQuestionIndex].wordInfo['词性']}}
          </view>
          <text class="question-stem-remainder">{{questions[currentQuestionIndex].stemRemainder}}</text>
        </view>
      </view>

      <!-- 选择题 -->
      <view class="options-container" wx:if="{{questions[currentQuestionIndex].type === 'choice'}}">
        <button 
          wx:for="{{questions[currentQuestionIndex].options}}" 
          wx:for-item="option"
          wx:key="index"
          class="option-button {{selectedOption === option ? (isCorrect && showAnswerCard ? 'correct' : (!isCorrect && showAnswerCard ? 'incorrect' : 'selected')) : ''}} {{showAnswerCard && option === questions[currentQuestionIndex].answer && option !== selectedOption ? 'correct-unselected' : ''}}"
          bindtap="onOptionSelect"
          data-option="{{option}}"
          disabled="{{showAnswerCard}}">
          {{option}}
        </button>
      </view>

      <!-- 填空题 -->
      <view wx:if="{{questions[currentQuestionIndex].type === 'fill'}}">
        <input 
          class="fill-input {{showAnswerCard ? (isCorrect ? 'correct-fill' : 'incorrect-fill') : ''}}" 
          placeholder="请输入答案"
          bindinput="handleAnswerInput" 
          value="{{userAnswer}}"
          disabled="{{showAnswerCard}}"/>

      </view>

      <view class="action-buttons-fixed">
        <!-- 提交答案和跳过本题按钮 -->
        <view class="button-group" wx:if="{{!showAnswerCard}}">
          <button 
            class="skip-button half-width-button" 
            bindtap="skipQuestion">
            跳过本题
          </button>
          <button 
            class="submit-button half-width-button" 
            bindtap="submitAnswer" 
            disabled="{{(questions[currentQuestionIndex].type === 'choice' && !selectedOption) || (questions[currentQuestionIndex].type === 'fill' && isUserAnswerEmpty) }}">
            提交答案
          </button>
        </view>

        <!-- 下一题按钮 -->
        <button 
          class="next-button full-width-button" 
          bindtap="nextQuestion" 
          wx:if="{{showAnswerCard}}">
          下一题
        </button>
      </view>
    </view>

    <!-- 答案反馈卡片 -->
    <view class="answer-card {{isCorrect ? 'correct' : 'incorrect'}}" wx:if="{{showAnswerCard}}">
      <view class="answer-text">{{isCorrect ? '回答正确！' : '回答错误！'}}</view>
      <view class="answer-text" wx:if="{{!isCorrect}}">
        正确答案: 
        <block wx:if="{{questions[currentQuestionIndex].answer.word || questions[currentQuestionIndex].answer.kana}}">
          {{questions[currentQuestionIndex].answer.word || ''}}<block wx:if="{{questions[currentQuestionIndex].answer.word && questions[currentQuestionIndex].answer.kana && questions[currentQuestionIndex].answer.word !== questions[currentQuestionIndex].answer.kana}}"> / {{questions[currentQuestionIndex].answer.kana}}</block><block wx:elif="{{!questions[currentQuestionIndex].answer.word && questions[currentQuestionIndex].answer.kana}}">{{questions[currentQuestionIndex].answer.kana}}</block>
        </block>
        <block wx:else>
          {{questions[currentQuestionIndex].answer}}
        </block>
      </view>
      <view class="word-details" wx:if="{{questions[currentQuestionIndex] && questions[currentQuestionIndex].wordInfo}}">
        <view wx:if="{{questions[currentQuestionIndex].wordInfo['假名']}}" class="detail-item">
          <text class="detail-label">假名:</text>
          <text class="detail-value">{{questions[currentQuestionIndex].wordInfo['假名']}}</text>
        </view>
        <view wx:if="{{questions[currentQuestionIndex].wordInfo['汉字']}}" class="detail-item">
          <text class="detail-label">汉字:</text>
          <text class="detail-value">{{questions[currentQuestionIndex].wordInfo['汉字']}}</text>
        </view>
        <view wx:if="{{questions[currentQuestionIndex].wordInfo['中文']}}" class="detail-item">
          <text class="detail-label">中文:</text>
          <text class="detail-value">{{questions[currentQuestionIndex].wordInfo['中文']}}</text>
        </view>
        <view wx:if="{{questions[currentQuestionIndex].wordInfo['例句']}}" class="detail-item">
          <text class="detail-label">例句:</text>
          <text class="detail-value">{{questions[currentQuestionIndex].wordInfo['例句']}}</text>
        </view>
        <view wx:if="{{questions[currentQuestionIndex].wordInfo['词性']}}" class="detail-item">
          <text class="detail-label">词性:</text>
          <view class="part-of-speech-tag {{questions[currentQuestionIndex].partOfSpeech}}">
            {{questions[currentQuestionIndex].wordInfo['词性']}}
          </view>
        </view>
      </view>
    </view>
  </block>

  <view wx:if="{{questions.length === 0 && lessonFile}}">
    <text>正在加载题目或当前课程没有题目...</text>
  </view>

</view>

<view class="container" wx:elif="{{!lessonFile}}">
  <text>错误：未指定课程文件。</text>
</view>

<wxs module="utils" src="../utils.wxs"></wxs>
<wxs module="timeFormatter">
  module.exports = {
    formatTime: function(seconds) {
      if (typeof seconds !== 'number' || seconds < 0) return '00:00:00';
      var h = Math.floor(seconds / 3600);
      var m = Math.floor((seconds % 3600) / 60);
      var s = seconds % 60;

      // 手动实现 padStart 的功能
      var hStr = h < 10 ? '0' + h : h.toString();
      var mStr = m < 10 ? '0' + m : m.toString();
      var sStr = s < 10 ? '0' + s : s.toString();

      return hStr + ':' + mStr + ':' + sStr;
    }
  }
</wxs>